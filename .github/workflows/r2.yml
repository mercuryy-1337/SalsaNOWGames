name: Build, Release and Deploy to R2

on:
  push:
    branches: [ master ]

jobs:
  deploy-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Upload salsa_version.json to R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_R2_TOKEN }}
        run: |
          wrangler r2 object put gfn/salsa_version.json --file ./salsa_version.json --remote
  
  build-and-deploy:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore SalsaNOWGames.sln

      - name: Build Release
        run: msbuild SalsaNOWGames.sln /p:Configuration=Release /p:Platform="Any CPU"

      - name: Get version from salsa_version.json
        id: get_version
        shell: pwsh
        run: |
          $json = Get-Content -Path salsa_version.json | ConvertFrom-Json
          $version = $json.version
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Extract changelog for current version
        id: changelog
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $content = Get-Content -Path CHANGELOG.md -Raw
          
          # Extract section for current version
          # Pattern matches from [version] to the next [version] or end of file
          $pattern = "(?s)## \[$version\].*?(?=## \[|---|\z)"
          $match = [regex]::Match($content, $pattern)
          
          if ($match.Success) {
            $changelog = $match.Value.Trim()
          } else {
            # Fallback to commit messages if version not found in changelog
            $lastTag = git describe --tags --abbrev=0 2>$null
            if ($LASTEXITCODE -ne 0) {
              $commits = git log --pretty=format:"- %s" -10
            } else {
              $commits = git log --pretty=format:"- %s" "$lastTag..HEAD"
            }
            $changelog = $commits -join "`n"
            if ([string]::IsNullOrEmpty($changelog)) {
              $changelog = "- Release v$version"
            }
          }
          
          # Write to file to handle multiline
          $changelog | Out-File -FilePath changelog.txt -Encoding utf8
          echo "Generated changelog for v$version"

      - name: Create source code archive
        shell: pwsh
        run: |
          Compress-Archive -Path * -DestinationPath SalsaNOWGames-source.zip -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: SalsaNOWGames v${{ steps.get_version.outputs.VERSION }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          files: |
            bin/Release/SalsaNOWGames.exe
            SalsaNOWGames-source.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SalsaNOWGames
          path: bin/Release/SalsaNOWGames.exe

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Upload to R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_R2_TOKEN }}
        run: |
          wrangler r2 object put gfn/SalsaNOWGames.exe --file ./bin/Release/SalsaNOWGames.exe --remote
